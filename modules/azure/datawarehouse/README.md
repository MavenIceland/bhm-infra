# datawarehouse

## Metric Alerts

This module implements the following metric alerts,
as [recommended by Microsoft](https://learn.microsoft.com/en-us/azure/azure-sql/database/monitoring-metrics-alerts?view=azuresql-db&preserve-view=true#recommended-alert-rules):

| Alert Name                         | Metric                         | Description                                                                               | Aggregation | Operator          | Threshold            | Severity      |
| ---------------------------------- | ------------------------------ | ----------------------------------------------------------------------------------------- | ----------- | ----------------- | -------------------- | ------------- |
| High User CPU Usage                | `cpu_percent`                  | Alerts when the average CPU usage by the user code exceeds 90%.                           | Average     | GreaterThan       | 90                   | Warning       |
| High Total CPU Usage               | `sql_instance_cpu_percent`     | Triggers an alert when the average total CPU usage of the SQL instance exceeds 90%.       | Average     | GreaterThan       | 90                   | Warning       |
| High Worker Usage                  | `workers_percent`              | Activates when the minimum percentage of SQL workers in use is greater than 60%.          | Minimum     | GreaterThan       | 60                   | Error         |
| High Data IO Usage                 | `physical_data_read_percent`   | Alerts if the average physical data read percentage goes above 90%.                       | Average     | GreaterThan       | 90                   | Informational |
| Storage Percent                    | `storage_percent`              | Issues an alert when the minimum storage usage exceeds 95%.                               | Minimum     | GreaterThan       | 95                   | Error         |
| Low TempDB Log Space               | `tempdb_log_used_percent`      | Raises an alert when the minimum percentage of used tempdb log space is greater than 60%. | Minimum     | GreaterThan       | 60                   | Error         |
| Failed Connections - System Errors | `connection_failed`            | Alerts on more than 10 failed connections due to system errors.                           | Total       | GreaterThan       | 10                   | Warning       |
| Deadlocks                          | `deadlock`                     | Monitors and alerts on deadlock occurrences in the database.                              | Total       | GreaterThan       | (Medium Sensitivity) | Informational |
| Failed Connections - User Errors   | `connection_failed_user_error` | Alerts on failed connections due to user errors, if they exceed a threshold.              | Total       | GreaterThan       | (Medium Sensitivity) | Warning       |
| Anomalous Connection Rate          | `connection_successful`        | Alerts on unusual rates of successful connections, indicating potential anomalies.        | Total       | GreaterOrLessThan | (Low Sensitivity)    | Warning       |

<!-- TERRAFORM_DOCS_BLOCK -->

## Inputs

| Name                                                                                                                                                   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Type                                                                                                                                                                                                                                                                                                                                                                                                           | Default  | Required |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | :------: |
| <a name="input_ad_sql_admin_display_name"></a> [ad_sql_admin_display_name](#input_ad_sql_admin_display_name)                                           | The Display Name of the Azure AD Principal to use as the SQL admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | n/a      |   yes    |
| <a name="input_ad_sql_admin_id"></a> [ad_sql_admin_id](#input_ad_sql_admin_id)                                                                         | ID of the Azure AD Principal to use as the SQL admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | n/a      |   yes    |
| <a name="input_instance"></a> [instance](#input_instance)                                                                                              | Identifier for the application, workload or service                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | n/a      |   yes    |
| <a name="input_key_vault_id"></a> [key_vault_id](#input_key_vault_id)                                                                                  | ID of the Key Vault to use for storing secrets                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | n/a      |   yes    |
| <a name="input_org_code"></a> [org_code](#input_org_code)                                                                                              | The organisation code for the environment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | n/a      |   yes    |
| <a name="input_resource_group_info"></a> [resource_group_info](#input_resource_group_info)                                                             | The id, name and location of the Resource Group into which the Data Warehouse should be placed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <pre>object({<br>    id       = string<br>    name     = string<br>    location = string<br>  })</pre>                                                                                                                                                                                                                                                                                                         | n/a      |   yes    |
| <a name="input_tier"></a> [tier](#input_tier)                                                                                                          | Tier of the environment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | n/a      |   yes    |
| <a name="input_allow_access_from_azure_services"></a> [allow_access_from_azure_services](#input_allow_access_from_azure_services)                      | Allow access to Azure services. This is done by setting start_ip_address and end_ip_address to 0.0.0.0.<br>  This rule only applies to Azure internal IPs, as documented in the Azure API Documentation:<br>  - https://learn.microsoft.com/en-us/rest/api/sql/firewall-rules/create-or-update?view=rest-sql-2021-11-01&tabs=HTTP<br>  - https://docs.microsoft.com/en-us/azure/azure-sql/database/firewall-configure#allow-access-to-azure-services                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `bool`                                                                                                                                                                                                                                                                                                                                                                                                         | `false`  |    no    |
| <a name="input_allow_sql_login"></a> [allow_sql_login](#input_allow_sql_login)                                                                         | Setting this to true will allow SQL authentication as well as Azure Entra authentication.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `bool`                                                                                                                                                                                                                                                                                                                                                                                                         | `false`  |    no    |
| <a name="input_audit_storage_account_name_override"></a> [audit_storage_account_name_override](#input_audit_storage_account_name_override)             | Override the name of the storage account to use for audit logs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | `null`   |    no    |
| <a name="input_databases"></a> [databases](#input_databases)                                                                                           | A map of SQL databases (keyed by instance/db-name) to provision in the Data Warehouse (SQL Server),<br>  - sku_name: The SKU name to use for the MS SQL Database. The SKU name determines the performance tier (and thus the price) of the database.<br>              See: https://docs.microsoft.com/en-us/azure/azure-sql/database/service-tiers-dtu<br>  - max_size_gb: The maximum size of the MS SQL Database in GB.<br>                 Keep in mind that the maximum size of a database varies between SKUs.<br>                 See: https://learn.microsoft.com/en-us/azure/azure-sql/database/resource-limits-logical-server?view=azuresql-db<br>  - collation: The collation to use for the MS SQL Database.<br>  - zone_redundant: Whether the MS SQL Database should be zone redundant. Only available for Standard and Premium SKUs.<br>                    See: https://docs.microsoft.com/en-us/azure/azure-sql/database/high-availability-sla#zone-redundant-database<br>  - name_override: Override the name of the database. If not set, the name will be generated according to the following pattern:<br>                   \<org_code>-<resource-abbreviation>-<name>-<tier><br>  - contributor_principal_ids: The Principal ID of an existing AD Principal (User, Group, Service Principal etc.) that should be granted contributor access to the database in question.<br><br>  Example:<pre>"db_name" = {<br>         sku_name       = var.warehouse_config.sku_name<br>         zone_redundant = var.warehouse_config.zone_redundant<br>         max_size_gb    = var.warehouse_config.max_size_gb<br>         collation      = "Icelandic_100_CI_AS"<br>         name_override  = null<br>         contributor_principal_ids = \["<principal-id1>", "<principal-id2>", \[...\] \]<br>     }</pre> | <pre>map(<br>    object({<br>      sku_name                  = string<br>      max_size_gb               = number<br>      collation                 = optional(string, "Icelandic_100_CI_AS")<br>      zone_redundant            = optional(bool, false)<br>      name_override             = optional(string, null)<br>      contributor_principal_ids = optional(list(string), \[\])<br>    })<br>  )</pre> | `{}`     |    no    |
| <a name="input_datawarehouse_contributor_principal_ids"></a> [datawarehouse_contributor_principal_ids](#input_datawarehouse_contributor_principal_ids) | A map of Azure Entra Principal IDs that should be granted contributor access to the Data Warehouse.<br>  Each key should be a semi-unique identifier (eg. a Group Name or purpose) for the Principal and the value should be the Principal ID.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                  | `{}`     |    no    |
| <a name="input_enable_monitor_alerts"></a> [enable_monitor_alerts](#input_enable_monitor_alerts)                                                       | Create metric alert rules for the databases in the datawarehouse.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `bool`                                                                                                                                                                                                                                                                                                                                                                                                         | `true`   |    no    |
| <a name="input_keyvault_key_name_override"></a> [keyvault_key_name_override](#input_keyvault_key_name_override)                                        | Override the name of the keyvault key to use for encryption                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | `null`   |    no    |
| <a name="input_monitor_alert_emails"></a> [monitor_alert_emails](#input_monitor_alert_emails)                                                          | Email addresses to send Azure Monitor alerts to.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                 | `[]`     |    no    |
| <a name="input_mssql_version"></a> [mssql_version](#input_mssql_version)                                                                               | Version of MSSQL to use                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | `"12.0"` |    no    |
| <a name="input_sql_server_name_override"></a> [sql_server_name_override](#input_sql_server_name_override)                                              | Override the name of the SQL Server. If not set, the name will be generated according to the following pattern: \<org_code>-<resource-abbreviation>-<name>-<tier>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | `null`   |    no    |
| <a name="input_tags"></a> [tags](#input_tags)                                                                                                          | Any tags that should be present on created resources. Will get merged with local.default_tags                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                  | `{}`     |    no    |
| <a name="input_tenant_id"></a> [tenant_id](#input_tenant_id)                                                                                           | The Azure tenant ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | `""`     |    no    |
| <a name="input_warehouse_ip_whitelist"></a> [warehouse_ip_whitelist](#input_warehouse_ip_whitelist)                                                    | A list of IP Addresses / Name pairs to whitelist for the datalakehouse                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <pre>list(<br>    object({<br>      ip_address = string<br>      name       = string<br>    })<br>  )</pre>                                                                                                                                                                                                                                                                                                    | `[]`     |    no    |
| <a name="input_warehouse_subnet_whitelist"></a> [warehouse_subnet_whitelist](#input_warehouse_subnet_whitelist)                                        | Subnet Id that should be able to access the warehouse                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `string`                                                                                                                                                                                                                                                                                                                                                                                                       | `null`   |    no    |

## Outputs

| Name                                                                                         | Description                                                           |
| -------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| <a name="output_db_info"></a> [db_info](#output_db_info)                                     | Information about the created database(s)                             |
| <a name="output_sql_server_fqdn"></a> [sql_server_fqdn](#output_sql_server_fqdn)             | Fully Qualified Domain Name (FQDN) of the Azure SQL Database created. |
| <a name="output_sql_server_id"></a> [sql_server_id](#output_sql_server_id)                   | The id of the datawarehouse                                           |
| <a name="output_sql_server_location"></a> [sql_server_location](#output_sql_server_location) | Location of the Azure SQL Database created.                           |
| <a name="output_sql_server_name"></a> [sql_server_name](#output_sql_server_name)             | Server name of the Azure SQL Database created.                        |
| <a name="output_sql_server_owner"></a> [sql_server_owner](#output_sql_server_owner)          | Owner of the Azure SQL Database created.                              |
| <a name="output_sql_server_version"></a> [sql_server_version](#output_sql_server_version)    | Version the Azure SQL Database created.                               |

## Resources

| Name                                                                                                                                                                        | Type        |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [azurerm_key_vault_access_policy.db](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_access_policy)                               | resource    |
| [azurerm_key_vault_access_policy.storage](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_access_policy)                          | resource    |
| [azurerm_key_vault_key.audit](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_key)                                                | resource    |
| [azurerm_monitor_action_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/monitor_action_group)                                   | resource    |
| [azurerm_monitor_metric_alert.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/monitor_metric_alert)                                   | resource    |
| [azurerm_mssql_firewall_rule.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/mssql_firewall_rule)                                     | resource    |
| [azurerm_mssql_firewall_rule.whitelist](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/mssql_firewall_rule)                                | resource    |
| [azurerm_mssql_server.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/mssql_server)                                                   | resource    |
| [azurerm_mssql_server_extended_auditing_policy.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/mssql_server_extended_auditing_policy) | resource    |
| [azurerm_mssql_virtual_network_rule.allow_subnet_access](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/mssql_virtual_network_rule)        | resource    |
| [azurerm_role_assignment.audit_contributor](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment)                                | resource    |
| [azurerm_storage_account.audit](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account)                                            | resource    |
| [azurerm_storage_account_customer_managed_key.audit](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account_customer_managed_key)  | resource    |
| [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config)                                           | data source |

## Modules

| Name                                                                                                                       | Source                   | Version |
| -------------------------------------------------------------------------------------------------------------------------- | ------------------------ | ------- |
| <a name="module_database"></a> [database](#module_database)                                                                | ../mssql-database        | n/a     |
| <a name="module_defaults"></a> [defaults](#module_defaults)                                                                | ../../skyvafnir/defaults | n/a     |
| <a name="module_naming_datawarehouse_audit_sa"></a> [naming_datawarehouse_audit_sa](#module_naming_datawarehouse_audit_sa) | Azure/naming/azurerm     | 0.2.0   |
| <a name="module_server_contributor_access"></a> [server_contributor_access](#module_server_contributor_access)             | ../role-assignment       | n/a     |

## Requirements

| Name                                                                     | Version |
| ------------------------------------------------------------------------ | ------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >= 1.1  |
| <a name="requirement_azurerm"></a> [azurerm](#requirement_azurerm)       | >=3.0.0 |

## Providers

| Name                                                         | Version |
| ------------------------------------------------------------ | ------- |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | 3.90.0  |

<!-- /TERRAFORM_DOCS_BLOCK -->
